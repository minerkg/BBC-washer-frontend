
<div class="flex justify-content-center my-5 px-3">
  <div class="col-12 md:col-10 lg:col-8 xl:col-6">
    <p-toast></p-toast>
    <p-card styleClass="shadow-24">
      <ng-template pTemplate="title" *ngIf="user">
        <div class="flex align-items-center gap-3">
          <p-avatar
            [label]="(user.first_name.substring(0,1) || '') + (user.last_name.substring(0,1) || '')"
            styleClass="p-mr-2"
            size="xlarge"
            shape="circle"></p-avatar>
          <div class="flex flex-column">
            <span class="font-bold">{{ user.first_name }} {{ user.last_name }}</span>
            <span class="text-sm text-gray-500">{{ user.username }}</span>
          </div>
        </div>
      </ng-template>

      <div *ngIf="user; else loadingProfile">
        <div *ngIf="!editMode; else editModeTemplate">
          <h4 class="mb-4">Profile details</h4>
          <div class="grid formgrid p-fluid">
            <div class="field col-12 md:col-6">
              <label>Email</label>
              <div class="p-inputgroup">
                <span class="p-inputgroup-addon"><i class="pi pi-envelope"></i></span>
                <input pInputText [value]="user.email" readonly />
              </div>
            </div>
            <div class="field col-12 md:col-6">
              <label>Phone</label>
              <div class="p-inputgroup">
                <span class="p-inputgroup-addon"><i class="pi pi-phone"></i></span>
                <input pInputText [value]="user.phone" readonly />
              </div>
            </div>
            <div class="field col-12 md:col-6">
              <label>Matriculation number</label>
              <div class="p-inputgroup">
                <span class="p-inputgroup-addon"><i class="pi pi-id-card"></i></span>
                <input pInputText [value]="user.nr_matricol" readonly />
              </div>
            </div>
            <div class="field col-12 md:col-6" *ngIf="user?.authorities?.length">
              <label>Roles</label>
              <div class="flex flex-wrap align-items-center gap-2 pt-2">
                <p-tag *ngFor="let authority of user.authorities"
                       [value]="authority.authority.replace('ROLE_', '')"
                       severity="info"></p-tag>
              </div>
            </div>
          </div>
          <div class="flex justify-content-end mt-5">
            <p-button label="Edit Profile" icon="pi pi-pencil" (onClick)="enableEditMode()"></p-button>
          </div>
        </div>

        <ng-template #editModeTemplate>
          <h4 class="mb-4">Edit Profile</h4>
          <div class="grid formgrid p-fluid">
            <div class="field col-12 md:col-6">
              <label for="editFirstName">First name</label>
              <input id="editFirstName" type="text" pInputText [(ngModel)]="editedUser!.first_name" required #firstName="ngModel" />
              <small *ngIf="firstName.invalid && firstName.dirty" class="p-error">First name is mandatory</small>
            </div>
            <div class="field col-12 md:col-6">
              <label for="editLastName">Last name</label>
              <input id="editLastName" type="text" pInputText [(ngModel)]="editedUser!.last_name" required #lastName="ngModel" />
              <small *ngIf="lastName.invalid && lastName.dirty" class="p-error">Last name is mandatory</small>
            </div>
            <div class="field col-12 md:col-6">
              <label for="editEmail">Email</label>
              <input id="editEmail" type="email" pInputText [(ngModel)]="editedUser!.email" required email #email="ngModel" />
              <small *ngIf="email.invalid && email.dirty" class="p-error">Enter a valid email</small>
            </div>
            <div class="field col-12 md:col-6">
              <label for="editPhone">Phone</label>
              <input id="editPhone" type="text" pInputText [(ngModel)]="editedUser!.phone" required #phone="ngModel" />
              <small *ngIf="phone.invalid && phone.dirty" class="p-error">Phone is mandatory</small>
            </div>
          </div>
          <div class="flex justify-content-end gap-2 mt-5">
            <p-button label="Cancel" icon="pi pi-times" styleClass="p-button-danger" (onClick)="cancelEdit()"></p-button>
            <p-button label="Save changes" icon="pi pi-check" (onClick)="saveProfile()"></p-button>
          </div>
        </ng-template>

        <p-divider layout="horizontal" class="my-5"></p-divider>

        <h4 class="mb-4">Password update</h4>
        <div class="grid formgrid p-fluid">
          <div class="field col-12">
            <label for="currentPassword">Current password</label>
            <input id="currentPassword" type="password" pInputText [(ngModel)]="currentPassword" required />
          </div>
          <div class="field col-12 md:col-6">
            <label for="newPassword">New password</label>
            <input id="newPassword" type="password" pInputText [(ngModel)]="newPassword" required />
          </div>
          <div class="field col-12 md:col-6">
            <label for="confirmNewPassword">Confirm new password</label>
            <input id="confirmNewPassword" type="password" pInputText [(ngModel)]="confirmNewPassword" required />
          </div>
        </div>
        <div class="flex justify-content-end mt-4">
          <p-button label="Update Password" icon="pi pi-key" (onClick)="changePassword()"></p-button>
        </div>

      </div>

      <ng-template #loadingProfile>
        <div class="flex align-items-center gap-3 mb-4">
          <p-skeleton shape="circle" size="4rem"></p-skeleton>
          <div class="flex-grow-1">
            <p-skeleton width="10rem" styleClass="mb-2"></p-skeleton>
            <p-skeleton width="5rem"></p-skeleton>
          </div>
        </div>
        <div class="grid formgrid p-fluid">
          <div class="field col-12 md:col-6"><p-skeleton height="3.5rem"></p-skeleton></div>
          <div class="field col-12 md:col-6"><p-skeleton height="3.5rem"></p-skeleton></div>
          <div class="field col-12 md:col-6"><p-skeleton height="3.5rem"></p-skeleton></div>
          <div class="field col-12 md:col-6"><p-skeleton height="3.5rem"></p-skeleton></div>
        </div>
      </ng-template>

    </p-card>
  </div>
</div>

<p-toast></p-toast>
